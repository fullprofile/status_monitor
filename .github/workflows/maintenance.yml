name: Onfarm and Insight Maintenance with Redirect

on:
  issues:
    types: [opened, closed]
  workflow_dispatch:

jobs:
  create_issue:
    name: Create issue on Onfarm and/or Insight repo
    runs-on: ubuntu-18.04
    if: ${{ github.event.action == 'opened' && contains(github.event.issue.labels.*.name, 'MAINTENANCE') }}

    steps:
      - uses: actions/checkout@v2

      - uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            if (github.event.issue.labels.some(l => l.name.includes('ONFARM'))) {
              await github.rest.issues.create({
                owner: 'fullprofile',
                repo: 'web-app-shell',
                // github.event.issue.id will be used to search when closing the issue
                title: `${{ github.event.issue.title }} - ${{ github.event.issue.id }}`,
                body: `${{ github.event.issue.body }}`,
                labels: `${{ github.event.issue.labels }}`,
              });
            };

            if (github.event.issue.labels.some(l => l.name.includes('INSIGHT'))) {
              await github.rest.issues.create({
                owner: 'fullprofile',
                repo: 'wp-report-app',
                // github.event.issue.id will be used to search when closing the issue
                title: `${{ github.event.issue.title }} - ${{ github.event.issue.id }}`,
                body: `${{ github.event.issue.body }}`,
                labels: `${{ github.event.issue.labels }}`,
              });
            };
  close_issue:
    name: Close issue on Onfarm and/or Insight repo
    runs-on: ubuntu-18.04
    if: ${{ github.event.action == 'closed' && contains(github.event.issue.labels.*.name, 'MAINTENANCE') }}

    steps:
      - uses: actions/checkout@v2

      - uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            if (github.event.issue.labels.some((l) => l.name.includes("ONFARM"))) {
              // Fetch all issues on Onfarm repo with filter
              const issues = await github.rest.issues.listForRepo({
                owner: "fullprofile",
                repo: "web-app-shell",
                labels: ["MAINTENANCE"], // Filter issues with banner label
                state: "open", // Filter open issues
              });

              // Extract the related issue created by issue from status_monitor
              const linkedIssue = issues.data.find((i) =>
                i.title.includes("${{ github.event.issue.id }}")
              );

              // Update Onfarm issue to close
              await github.rest.issues.update({
                owner: "fullprofile",
                repo: "web-app-shell",
                issue_number: linkedIssue.number,
                state: "closed",
              });
            }

            if (github.event.issue.labels.some((l) => l.name.includes("INSIGHT"))) {
              // Fetch all issues on Insight repo with filter
              const issues = await github.rest.issues.listForRepo({
                owner: "fullprofile",
                repo: "wp-report-app",
                labels: ["MAINTENANCE"], // Filter issues with banner label
                state: "open", // Filter open issues
              });

              // Extract the related issue created by issue from status_monitor
              const linkedIssue = issues.data.find((i) =>
                i.title.includes("${{ github.event.issue.id }}")
              );

              // Update Insight issue to close
              await github.rest.issues.update({
                owner: "fullprofile",
                repo: "wp-report-app",
                issue_number: linkedIssue.number,
                state: "closed",
              });
            }
